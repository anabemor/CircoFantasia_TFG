<app-navbar-admin></app-navbar-admin>

<div class="p-6 max-w-7xl mx-auto">
  <h2 class="text-2xl font-bold mb-4 text-gray-800">Gestión de Reservas</h2>

  <!-- Botones de acción -->
<div class="flex justify-between items-center mb-6">
  <button
    *ngIf="!mostrarFormularioCreacion && !mostrarFormularioEdicion"
    class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600"
    (click)="abrirFormularioCrear()"
  >
    Crear nueva reserva
  </button>

  <button
    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
    (click)="toggleAforo()"
  >
    {{ mostrarAforo ? 'Ocultar aforo' : 'Ver aforo' }}
  </button>
</div>



  <!-- Tabla de aforo -->
  <app-aforo *ngIf="mostrarAforo" class="mb-10"></app-aforo>

  <!-- Buscador -->
  <div class="flex flex-wrap md:flex-nowrap gap-4 mb-6 items-end">
  <!-- Buscar por nombre/email -->
    <input
      type="text"
      [(ngModel)]="filtroTexto"
      (ngModelChange)="aplicarFiltros()"
      placeholder="Buscar por nombre o email"
      class="border p-2 rounded w-full md:w-1/4"
    />

    <!-- Fecha -->
    <input
      type="date"
      [(ngModel)]="filtroFecha"
      (change)="aplicarFiltros()"
      class="border p-2 rounded w-full md:w-1/4"
    />

    <!-- Estado -->
    <div class="w-full md:w-1/4">
      <select
        [(ngModel)]="filtroEstado"
        (change)="aplicarFiltros()"
        class="border p-2 rounded w-full"
      >
        <option value="">Todos los estados</option>
        <option value="pagado">Pagado</option>
        <option value="pendiente">Pendiente</option>
        <option value="cancelado">Cancelado</option>
      </select>
    </div>

    <!-- Botón borrar -->
    <div class="w-full md:w-auto">
      <button
        class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded w-full md:w-auto"
        (click)="limpiarFiltros()"
      >
        Borrar filtros
      </button>
    </div>
  </div>
  

  <!-- Tabla de reservas -->
  <ng-container *ngIf="!mostrarFormularioCreacion && !mostrarFormularioEdicion; else formularioActivo">
    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden shadow">
      <thead class="bg-indigo-600 text-white">
        <tr>
          <th class="px-4 py-2 cursor-pointer" (click)="ordenarPor('nombre')">
            Nombre
            <span *ngIf="ordenActual === 'nombre'">{{ ordenAscendente ? '▲' : '▼' }}</span>
          </th>
          <th class="px-4 py-2 cursor-pointer" (click)="ordenarPor('email')">
            Email
            <span *ngIf="ordenActual === 'email'">{{ ordenAscendente ? '▲' : '▼' }}</span>
          </th>
          <th class="px-4 py-2 text-center">Teléfono</th>
          <th class="px-4 py-2 cursor-pointer" (click)="ordenarPor('fechaVisita')">
            Fecha Visita
            <span *ngIf="ordenActual === 'fechaVisita'">{{ ordenAscendente ? '▲' : '▼' }}</span>
          </th>
          <th class="px-4 py-2 cursor-pointer" (click)="ordenarPor('fechaReserva')">
            Fecha Reserva
            <span *ngIf="ordenActual === 'fechaReserva'">{{ ordenAscendente ? '▲' : '▼' }}</span>
          </th>
          <th class="px-4 py-2 text-center">Adultos</th>
          <th class="px-4 py-2 text-center">Niños</th>
          <th class="px-4 py-2 text-center">Total</th>
          <th class="px-4 py-2 text-center cursor-pointer" (click)="ordenarPor('estado')">
            Estado
            <span *ngIf="ordenActual === 'estado'">{{ ordenAscendente ? '▲' : '▼' }}</span>
          </th>
          <th class="px-4 py-2">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let reserva of reservasFiltradasPaginaActual" class="border-t border-gray-200">
          <td class="px-4 py-2">{{ reserva.nombre }} {{ reserva.apellidos }}</td>
          <td class="px-4 py-2">{{ reserva.email }}</td>
          <td class="px-4 py-2 text-center">{{ reserva.telefono }}</td>
          <td class="px-4 py-2">{{ reserva.fechaVisita }}</td>
          <td class="px-4 py-2">{{ reserva.fechaReserva }}</td>
          <td class="px-4 py-2 text-center">{{ contarEntradas(reserva, 'adulto') }}</td>
          <td class="px-4 py-2 text-center">{{ contarEntradas(reserva, 'niño') }}</td>
          <td class="px-4 py-2 text-center">{{ calcularPrecioTotal(reserva) | currency:'EUR' }}</td>
          <td class="px-4 py-2">
            <span [ngClass]="{
              'text-yellow-600 font-semibold': reserva.estado === 'pendiente',
              'text-green-600 font-semibold': reserva.estado === 'pagado',
              'text-red-600 font-semibold': reserva.estado === 'cancelado'
            }">
              {{ getEstadoVisual(reserva.estado) }}
            </span>
          </td>
          <td class="px-4 py-2 space-x-2">
            <button class="text-blue-600 hover:underline" (click)="editarReserva(reserva)">Editar</button>
            <button class="text-red-600 hover:underline" (click)="eliminarReserva(reserva.id!)">Eliminar</button>
            <button class="text-yellow-600 hover:underline" *ngIf="reserva.estado !== 'cancelado'" (click)="cancelarReserva(reserva)">Cancelar</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Navegación paginación -->
    <div class="mt-4 flex justify-center gap-2 text-sm">
      <button class="px-3 py-1 border rounded" [disabled]="currentPage === 1" (click)="cambiarPagina(currentPage - 1)">
        ← Anterior
      </button>
      <span>Página {{ currentPage }} de {{ totalPages }}</span>
      <button class="px-3 py-1 border rounded" [disabled]="currentPage === totalPages" (click)="cambiarPagina(currentPage + 1)">
        Siguiente →
      </button>
    </div>
  </ng-container>

  <!-- Formularios -->
  <ng-template #formularioActivo>
    <app-reserva-create-form
      *ngIf="mostrarFormularioCreacion"
      [aforoError]="aforoError" 
      (formSubmit)="crearReserva($event)"
    ></app-reserva-create-form>

    <app-reserva-form
      *ngIf="mostrarFormularioEdicion"
      [reserva]="reservaEnEdicion"
      (formSubmit)="guardarReserva($event)"
    ></app-reserva-form>
  </ng-template>
</div>
